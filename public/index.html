<script type="text/javascript">
    
    // En dıştaki başlatıcı
    window.addEventListener('load', function () {
        // Kütüphanelerin yüklendiğinden emin ol
        if (typeof Phaser === 'undefined' || typeof firebase === 'undefined' || typeof Telegram === 'undefined') {
            document.body.innerHTML = `<h1 style="color:red;">Error: Core libraries did not load.</h1>`;
            return;
        }
        // Telegram hazır olduğunda oyunu başlat
        Telegram.WebApp.ready(runGame);
    });


    function runGame() {
        try {
            // --- 1. KURULUM ---
            const firebaseConfig = { apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc", authDomain: "peacemissile-game.firebaseapp.com", projectId: "peacemissile-game", storageBucket: "peacemissile-game.firebasestorage.app", messagingSenderId: "641906716058", appId: "1:641906716058:web:1376e93994fab29f049e23" };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;
            const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
            tg.expand();

            // --- 2. PHASER SAHNELERİNİ ÖNCEDEN TANIMLA ---
            
            class Preloader extends Phaser.Scene {
                constructor() { super({ key: 'Preloader' }); }
                preload() {
                    this.load.image('lobby_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/lobby_bg.jpg');
                    this.load.image('play_button', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/play_button.png');
                    this.load.image('score_icon', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/score_icon.png');
                    this.load.image('coin_icon', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/coin_icon.png');
                    // Oyun için gerekli diğer resimleri de burada yükle
                    this.load.image('israel_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/israel_bg.jpg');
                    this.load.image('iran_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/iran_bg.jpg');
                    this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
                    this.load.spritesheet('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif', { frameWidth: 64, frameHeight: 64 });
                }
                create() {
                    this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true });
                    this.scene.start('LobbyScene');
                }
            }

            class LobbyScene extends Phaser.Scene {
                constructor() { super({ key: 'LobbyScene' }); }
                create() {
                    const gameWidth = this.cameras.main.width; const gameHeight = this.cameras.main.height;
                    this.add.image(gameWidth / 2, gameHeight / 2, 'lobby_bg').setDisplaySize(gameWidth, gameHeight);
                    this.add.text(gameWidth / 2, 100, `Welcome, ${currentUser ? currentUser.first_name : 'Ambassador'}!`, { fontSize: '48px', fill: '#fff', stroke: '#000', strokeThickness: 6 }).setOrigin(0.5);
                    const playButton = this.add.image(gameWidth / 2, gameHeight - 150, 'play_button').setScale(0.8).setInteractive({ useHandCursor: true });
                    playButton.on('pointerdown', () => { this.scene.start('GameScene'); });
                    const highScoreText = this.add.text(gameWidth / 2 + 40, 250, `Loading...`, { fontSize: '28px', fill: '#fff' }).setOrigin(0.5);
                    const coinsText = this.add.text(gameWidth / 2 + 40, 350, `Loading...`, { fontSize: '28px', fill: '#fff' }).setOrigin(0.5);
                    this.add.image(gameWidth / 2 - 100, 250, 'score_icon').setScale(0.7);
                    this.add.image(gameWidth / 2 - 100, 350, 'coin_icon').setScale(0.7);
                    if (currentUser && db) {
                        const userDocRef = db.collection('users').doc(String(currentUser.id));
                        userDocRef.get().then(doc => {
                            if (doc.exists) { const data = doc.data(); highScoreText.setText(`${data.score || 0}`); coinsText.setText(`${data.total_pmno_coins || 0}`); }
                            else { highScoreText.setText(`0`); coinsText.setText(`0`); }
                        }).catch(err => console.error("Data fetch error:", err));
                    }
                }
            }

            class GameScene extends Phaser.Scene {
                constructor() { super({ key: 'GameScene' }); }
                create() {
                    this.sessionScore = 0; this.health = 3; this.isGameOver = false;
                    const urlParams = new URLSearchParams(window.location.search);
                    const selectedSide = urlParams.get('side') || 'israel';
                    this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, selectedSide === 'iran' ? 'iran_bg' : 'israel_bg').setDisplaySize(this.cameras.main.width, this.cameras.main.height);
                    this.scoreText=this.add.text(16,16,"Score: 0",{fontSize:"32px",fill:"#fff",stroke:"#000",strokeThickness:4}),this.healthText=this.add.text(this.cameras.main.width-16,16,"Health: 3",{fontSize:"32px",fill:"#fff",stroke:"#000",strokeThickness:4}).setOrigin(1,0),this.rockets=this.physics.add.group(),this.time.addEvent({delay:1300,callback:this.spawnRocket,callbackScope:this,loop:!0})
                }
                spawnRocket(){if(this.isGameOver)return;const e=Phaser.Math.Between(40,this.cameras.main.width-40),t=this.rockets.create(e,-100,"rocket");t.setAngle(180),t.setVelocityY(Phaser.Math.Between(300,500)),t.setInteractive({useHandCursor:!0}),t.on("pointerdown",()=>this.destroyRocket(t))}
                destroyRocket(e){if(!e.active)return;this.sessionScore+=10,this.scoreText.setText("Score: "+this.sessionScore);let t=this.add.sprite(e.x,e.y,"explosion");t.play("explode_anim"),e.destroy()}
                update(){if(this.isGameOver)return;this.rockets.children.each(e=>{if(e.y>this.cameras.main.height+100){e.destroy(),this.health-=1,this.healthText.setText("Health: "+this.health),this.health<=0&&this.gameOver()}})}
                gameOver() { if (this.isGameOver) return; this.isGameOver = true; this.physics.pause(); this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + this.sessionScore, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5); if (currentUser && this.sessionScore > 0 && db) { const e = db.collection("users").doc(String(currentUser.id)); e.get().then(t => { if (t.exists) { const s = t.data(); e.update({ total_score: firebase.firestore.FieldValue.increment(this.sessionScore), total_pmno_coins: firebase.firestore.FieldValue.increment(this.sessionScore + (this.sessionScore > s.score ? 100 * this.sessionScore : 0)), score: Math.max(s.score, this.sessionScore) }) } else e.set({ score: this.sessionScore, total_score: this.sessionScore, total_pmno_coins: this.sessionScore + 100 * this.sessionScore, username: currentUser.username || currentUser.first_name, user_id: currentUser.id }) }).catch(e => console.error("Firebase Error:", e)) } setTimeout(() => this.scene.start('LobbyScene'), 4000) }
            }

            // --- 3. OYUN YAPILANDIRMASI ---
            const config = {
                type: Phaser.AUTO,
                width: window.innerWidth,
                height: window.innerHeight,
                physics: { default: 'arcade' },
                scene: [ Preloader, LobbyScene, GameScene ] // Sahneleri doğru sırayla ekle
            };
            
            // Oyunu başlat
            new Phaser.Game(config);

        } catch (e) {
            document.body.innerHTML = `<h1 style="color:red; padding: 20px;">RUNTIME ERROR: ${e.message}</h1>`;
        }
    }

</script>
</body>
</html>