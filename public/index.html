<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } canvas { display: block; } </style>
</head>
<body>
<div id="phaser-game"></div>

<script type="text/javascript">
    // --- GLOBAL DEĞİŞKENLER ---
    const tg = window.Telegram.WebApp;
    const currentUser = tg.initDataUnsafe?.user;
    let db;

    // --- FIREBASE KURULUMU ---
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc",
            authDomain: "peacemissile-game.firebaseapp.com",
            projectId: "peacemissile-game",
            storageBucket: "peacemissile-game.firebasestorage.app",
            messagingSenderId: "641906716058",
            appId: "1:641906716058:web:1376e93994fab29f049e23"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase başarıyla başlatıldı.");
        } else {
            db = firebase.app().firestore();
            console.log("Firebase zaten başlatılmıştı.");
        }
    } catch (e) {
        console.error("Firebase başlatma başarısız oldu:", e);
    }

    // --- PHASER OYUN SAHNESİ ---
    class GameScene extends Phaser.Scene {
        constructor() {
            super({ key: 'GameScene' });
            // ... (constructor içeriği aynı kalabilir)
            this.score = 0;
            this.gameIsOver = false;
        }

        preload() {
            // ... (preload içeriği aynı kalabilir)
            const urlParams = new URLSearchParams(window.location.search);
            this.selectedSide = urlParams.get('side') || 'israel';
            const bgUrl = this.selectedSide === 'iran' 
                ? 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/iran_bg.jpg' 
                : 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/israel_bg.jpg';
            this.load.image('background', bgUrl);
            this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
            this.load.image('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif');
            this.load.image('destroyed_building', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/destroyed_building.png'); 
            this.load.image('dove', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/dove.png');
        }

        create() {
            // ... (create içeriği büyük oranda aynı, hitBuilding'deki saveScore çağrısı önemli)
            const gameWidth = this.cameras.main.width;
            const gameHeight = this.cameras.main.height;
            let bg = this.add.image(gameWidth / 2, gameHeight / 2, 'background');
            bg.setDisplaySize(gameWidth, gameHeight);
            
            this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff'});
            this.buildings = this.physics.add.staticGroup();
            
            // Bina oluşturma mantığı... (Kısaltıldı, sizde doğru hali var)
            // Örnek: this.buildings.create(300, gameHeight - 100, 'building');
            // ...
            
            this.rockets = this.physics.add.group();
            this.physics.add.collider(this.rockets, this.buildings, this.hitBuilding, null, this);
            this.time.addEvent({ delay: 1500, callback: this.spawnRocket, callbackScope: this, loop: true });
        }

        spawnRocket() {
            if (this.gameIsOver) return;
            // ... (roket oluşturma mantığı aynı)
        }
        
        destroyRocket(rocket) {
            if(this.gameIsOver) return;
            this.score += 10;
            this.scoreText.setText('Score: ' + this.score);
            rocket.destroy();
            // ... (efektler)
        }

        hitBuilding(rocket, building) {
            if(this.gameIsOver) return;
            rocket.destroy();
            building.destroy(); // Basitçe binayı yok et
            
            // Tüm binalar yok olduysa oyunu bitir
            if (this.buildings.countActive(true) === 0) {
                // Oyunu bitir ve skoru kaydet.
                // Bu fonksiyon artık tüm işi kendisi yapacak.
                this.saveScoreAndEndGame(this.score);
            }
        }
        
        async saveScoreAndEndGame(finalScore) {
            if (this.gameIsOver) return;
            this.gameIsOver = true;
            this.physics.pause();
            
            console.log(`Oyun bitti. Skor: ${finalScore}. Kaydediliyor...`);

            if (!db || !currentUser || !currentUser.id) {
                console.error("Firebase veya kullanıcı bilgisi yok. Skor kaydedilemiyor.");
                this.gameOver(false); // Yeni rekor olmadan bitir.
                return;
            }

            const userDocRef = db.collection('users').doc(String(currentUser.id));
            let isNewHighScore = false;

            try {
                const doc = await userDocRef.get();
                
                let currentData = {
                    score: 0,
                    total_score: 0,
                    total_pmno_coins: 0
                };

                if (doc.exists) {
                    currentData = doc.data();
                }

                const newTotalScore = (currentData.total_score || 0) + finalScore;
                let newCoins = (currentData.total_pmno_coins || 0) + finalScore;
                let newHighScore = currentData.score || 0;

                if (finalScore > newHighScore) {
                    isNewHighScore = true;
                    newHighScore = finalScore;
                    newCoins += finalScore * 100; // Rekor bonusu
                    console.log("Yeni rekor kırıldı!");
                }
                
                const updateData = {
                    username: currentUser.username || currentUser.first_name,
                    score: newHighScore,
                    total_score: newTotalScore,
                    total_pmno_coins: newCoins,
                };
                
                await userDocRef.set(updateData, { merge: true });
                console.log("Skor başarıyla Firebase'e kaydedildi:", updateData);

                // Bot'a sadece bilgi amaçlı bir sinyal gönderilebilir, ama zorunlu değil.
                // sendScoreToBot(currentUser.id, finalScore);
                
                this.gameOver(isNewHighScore);

            } catch (error) {
                console.error("Skor kaydedilirken hata oluştu:", error);
                this.gameOver(false); // Hata durumunda da oyunu bitir.
            }
        }

        gameOver(isNewHighScore) {
            // ... (gameOver animasyonlarınız aynı kalabilir)
            if (isNewHighScore) {
                this.add.text(this.cameras.main.width / 2, this.cameras.main.height / 2, `NEW HIGH SCORE!\n${this.score}`, { fontSize: '48px', fill: '#FFD700' }).setOrigin(0.5);
            } else {
                this.add.text(this.cameras.main.width / 2, this.cameras.main.height / 2, `Game Over\nScore: ${this.score}`, { fontSize: '48px', fill: '#ff0000' }).setOrigin(0.5);
            }
        }
    }

    // --- PHASER KONFİGÜRASYONU ---
    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
        scene: GameScene
    };
    new Phaser.Game(config);

</script>
</body>
</html>