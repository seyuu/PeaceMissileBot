<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- YENİ: Firebase kütüphaneleri -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">

function runGame() {
    try {
        // --- 1. FIREBASE KURULUMU ---
         const firebaseConfig = {
            apiKey: "AIzaSyBtOkm8dpjVXlzAXCEB5sL_Awqq4HEeemc",
            authDomain: "peacemissile-game.firebaseapp.com",
            projectId: "peacemissile-game",
            storageBucket: "peacemissile-game.firebasestorage.app",
            messagingSenderId: "641906716058",
            appId: "1:641906716058:web:1376e93994fab29f049e23"
            };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. GLOBAL DEĞİŞKENLER ---
        const tg = window.Telegram.WebApp;
        const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
        let sessionScore = 0;

        // --- 3. PHASER SAHNESİ ---
        class GameScene extends Phaser.Scene {
            constructor() { super({ key: 'GameScene' }); }
            preload() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedSide = urlParams.get('side') || 'israel';
                this.load.image('background', `https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/${this.selectedSide}_bg.jpg`);
                this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
                this.load.image('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif');
            }
            create() {
                this.health = 3; this.isGameOver = false; sessionScore = 0;
                let bg = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, 'background');
                bg.setDisplaySize(this.cameras.main.width, this.cameras.main.height);
                this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
                this.healthText = this.add.text(this.cameras.main.width - 16, 16, 'Health: 3', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0);
                this.rockets = this.physics.add.group();
                this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true });
            }
            spawnRocket(){if(this.isGameOver)return;const e=Phaser.Math.Between(40,this.cameras.main.width-40),t=this.rockets.create(e,-100,"rocket");t.setAngle(180),t.setVelocityY(Phaser.Math.Between(300,500)),t.setInteractive({useHandCursor:!0}),t.on("pointerdown",()=>this.destroyRocket(t))}
            destroyRocket(e){if(!e.active)return;sessionScore+=10,this.scoreText.setText("Score: "+sessionScore);const t=this.add.image(e.x,e.y,"explosion").setScale(.5);this.time.delayedCall(150,()=>t.destroy()),e.destroy()}
            update() {
                if (this.isGameOver) return;
                this.rockets.children.each(rocket => {
                    if (rocket.y > this.cameras.main.height + 100) {
                        rocket.destroy(); this.health -= 1;
                        this.healthText.setText('Health: ' + this.health);
                        if (this.health <= 0) this.gameOver();
                    }
                });
            }
            gameOver() {
                if (this.isGameOver) return;
                this.isGameOver = true; this.physics.pause();
                this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + sessionScore, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);
                
                // FIREBASE SKOR KAYDETME
                if (currentUser && sessionScore > 0) {
                    const userDocRef = db.collection('users').doc(String(currentUser.id));
                    userDocRef.update({
                        score: firebase.firestore.FieldValue.increment(sessionScore),
                        username: currentUser.username || currentUser.first_name // Kullanıcı adını da güncelleyelim
                    }).catch(err => {
                        // Eğer kullanıcı ilk kez oynuyorsa ve kayıt yoksa, update hata verir. O zaman set kullan.
                        if (err.code === 'not-found') {
                            userDocRef.set({ score: sessionScore, username: currentUser.username || currentUser.first_name });
                        } else {
                            console.error("Firebase Error:", err);
                        }
                    });
                }
                setTimeout(() => tg.close(), 4000);
            }
        }
        
        const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: GameScene };
        new Phaser.Game(config);

    } catch(e) {
        document.body.innerHTML = `<h1 style="color:red;">Error: ${e.message}</h1>`;
    }
}

// --- BAŞLATICI ---
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready(runGame);
} else {
    // Tarayıcıda test için
    window.addEventListener('load', runGame);
}
</script>
</body>
</html>