<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">

function runGame() {
    try {
        // --- 1. KURULUM ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc",
            authDomain: "peacemissile-game.firebaseapp.com",
            projectId: "peacemissile-game",
            storageBucket: "peacemissile-game.firebasestorage.app",
            messagingSenderId: "641906716058",
            appId: "1:641906716058:web:1376e93994fab29f049e23"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const tg = window.Telegram.WebApp;
        const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
        
        // --- 2. PHASER SAHNESİ ---
        class GameScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameScene' });
            }

            preload() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedSide = urlParams.get('side') || 'israel';
                this.load.image('background', `https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/${this.selectedSide}_bg.jpg`);
                this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
                this.load.spritesheet('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif', { frameWidth: 64, frameHeight: 64 });
            }

            create() {
                this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true });
                
                this.sessionScore = 0;
                this.health = 3;
                this.isGameOver = false;

                let bg = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, 'background');
                bg.setDisplaySize(this.cameras.main.width, this.cameras.main.height);

                this.buildings = this.physics.add.staticGroup();
                // Haritaya göre bina sınırları (senin isteğine göre ayarlanabilir)
                if (this.selectedSide === 'israel') {
                    this.buildings.create(this.cameras.main.width * 0.5, this.cameras.main.height, null).setSize(this.cameras.main.width, 250).setOrigin(0.5, 1).setVisible(false).refreshBody();
                } else {
                    this.buildings.create(this.cameras.main.width * 0.5, this.cameras.main.height, null).setSize(this.cameras.main.width, 200).setOrigin(0.5, 1).setVisible(false).refreshBody();
                }

                this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
                this.healthText = this.add.text(this.cameras.main.width - 16, 16, 'Health: 3', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0);

                this.rockets = this.physics.add.group();
                this.physics.add.collider(this.rockets, this.buildings, this.hitBuilding, null, this);
                
                this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true });
            }

            spawnRocket() {
                if (this.isGameOver) return;
                const x = Phaser.Math.Between(40, this.cameras.main.width - 40);
                const rocket = this.rockets.create(x, -100, "rocket");
                rocket.setAngle(180);
                rocket.setVelocityY(Phaser.Math.Between(300, 500));
                rocket.setInteractive({ useHandCursor: true });
                rocket.on("pointerdown", () => this.destroyRocket(rocket));
            }
            
            destroyRocket(rocket) {
                if (!rocket.active) return;
                this.sessionScore += 10;
                this.scoreText.setText("Score: " + this.sessionScore);
                let explosionSprite = this.add.sprite(rocket.x, rocket.y, 'explosion');
                explosionSprite.play('explode_anim');
                rocket.destroy();
            }

            hitBuilding(rocket, building) {
                if (!rocket.active) return;
                this.health -= 1;
                this.healthText.setText("Health: " + this.health);
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
                let explosionSprite = this.add.sprite(rocket.x, rocket.y, 'explosion');
                explosionSprite.play('explode_anim').setTint(0xff0000); // Kırmızı patlama
                this.cameras.main.shake(100, 0.01);
                rocket.destroy();
                if (this.health <= 0) {
                    this.gameOver();
                }
            }
            
            gameOver() {
                if (this.isGameOver) return;
                this.isGameOver = true;
                this.physics.pause();
                this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + this.sessionScore, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);
                
                if (currentUser && this.sessionScore > 0) {
                    const userDocRef = db.collection('users').doc(String(currentUser.id));
                    userDocRef.get().then(doc => {
                        if (doc.exists) {
                            userDocRef.update({ score: firebase.firestore.FieldValue.increment(this.sessionScore) });
                        } else {
                            userDocRef.set({ score: this.sessionScore, username: currentUser.username || currentUser.first_name, user_id: currentUser.id });
                        }
                    }).catch(err => console.error("Firebase Error:", err));
                }
                
                setTimeout(() => tg.close(), 4000);
            }
        }
        
        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            physics: { default: 'arcade' },
            scene: GameScene
        };
        new Phaser.Game(config);

    } catch(e) {
        document.body.innerHTML = `<h1 style="color:red;">Error: ${e.message}</h1>`;
    }
}

// --- BAŞLATICI ---
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready(runGame);
} else {
    window.addEventListener('load', runGame);
}

</script>
</body>
</html>