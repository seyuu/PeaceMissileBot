<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <!-- Kütüphaneler -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">
    
    // Tüm mantığı, sayfa tamamen yüklendikten sonra çalışacak olan bir fonksiyona taşıyalım
    function startApp() {
        try {
            // --- 1. KURULUM ---
            const firebaseConfig = {
                apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc",
                authDomain: "peacemissile-game.firebaseapp.com",
                projectId: "peacemissile-game",
                storageBucket: "peacemissile-game.firebasestorage.app",
                messagingSenderId: "641906716058",
                appId: "1:641906716058:web:1376e93994fab29f049e23"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const tg = window.Telegram.WebApp;
            const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
            tg.ready();
            tg.expand();

            // --- Lobi Sahnesi ---
            class LobbyScene extends Phaser.Scene {
                // ... (Lobi sahnesi kodu aynı) ...
                constructor() { super({ key: 'LobbyScene' }); }
                preload() { this.load.image('lobby_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/lobby_bg.jpg'); this.load.image('play_button', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/play_button.png'); this.load.image('score_icon', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/score_icon.png'); this.load.image('coin_icon', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/coin_icon.png'); }
                create() {
                    const gameWidth = this.cameras.main.width; const gameHeight = this.cameras.main.height;
                    this.add.image(gameWidth / 2, gameHeight / 2, 'lobby_bg').setDisplaySize(gameWidth, gameHeight);
                    this.add.text(gameWidth / 2, 100, `Welcome, ${currentUser ? currentUser.first_name : 'Ambassador'}!`, { fontSize: '48px', fill: '#fff', stroke: '#000', strokeThickness: 6 }).setOrigin(0.5);
                    const playButton = this.add.image(gameWidth / 2, gameHeight - 150, 'play_button').setScale(0.8).setInteractive({ useHandCursor: true });
                    playButton.on('pointerdown', () => { this.scene.start('GameScene'); });
                    const highScoreText = this.add.text(gameWidth / 2 + 40, 250, `Loading...`, { fontSize: '28px', fill: '#fff' }).setOrigin(0.5);
                    const coinsText = this.add.text(gameWidth / 2 + 40, 350, `Loading...`, { fontSize: '28px', fill: '#fff' }).setOrigin(0.5);
                    this.add.image(gameWidth / 2 - 100, 250, 'score_icon').setScale(0.7);
                    this.add.image(gameWidth / 2 - 100, 350, 'coin_icon').setScale(0.7);
                    if (currentUser && db) {
                        const userDocRef = db.collection('users').doc(String(currentUser.id));
                        userDocRef.get().then(doc => {
                            if (doc.exists) { const data = doc.data(); highScoreText.setText(`${data.score || 0}`); coinsText.setText(`${data.total_pmno_coins || 0}`); }
                            else { highScoreText.setText(`0`); coinsText.setText(`0`); }
                        }).catch(err => console.error("Data fetch error:", err));
                    }
                }
            }

            // --- Oyun Sahnesi ---
            class GameScene extends Phaser.Scene {
                // ... (Oyun sahnesi kodu aynı) ...
                constructor() { super({ key: 'GameScene' }); }
                preload() { const urlParams = new URLSearchParams(window.location.search); this.selectedSide = urlParams.get('side') || 'israel'; this.load.image('background', `https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/${this.selectedSide}_bg.jpg`); this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png'); this.load.spritesheet('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif', { frameWidth: 64, frameHeight: 64 }); }
                create() { this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true }); this.sessionScore = 0; this.health = 3; this.isGameOver = false; let bg = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, 'background'); bg.setDisplaySize(this.cameras.main.width, this.cameras.main.height); this.buildings = this.physics.add.staticGroup(); this.buildings.create(this.cameras.main.width / 2, this.cameras.main.height).setSize(this.cameras.main.width, this.cameras.main.height * 0.2).setOrigin(0.5, 0.8).setVisible(false).refreshBody(); this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }); this.healthText = this.add.text(this.cameras.main.width - 16, 16, 'Health: 3', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0); this.rockets = this.physics.add.group(); this.physics.add.collider(this.rockets, this.buildings, this.hitBuilding, null, this); this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true }); }
                spawnRocket() { if (this.isGameOver) return; const e = Phaser.Math.Between(40, this.cameras.main.width - 40); const t = this.rockets.create(e, -100, "rocket"); t.setAngle(180), t.setVelocityY(Phaser.Math.Between(300, 500)), t.setInteractive({ useHandCursor: !0 }), t.on("pointerdown", () => this.destroyRocket(t)) }
                destroyRocket(e) { if (!e.active) return; this.sessionScore += 10; this.scoreText.setText("Score: " + this.sessionScore); let t = this.add.sprite(e.x, e.y, "explosion"); t.play("explode_anim"), e.destroy() }
                hitBuilding(e, t) { if (!e.active) return; this.health -= 1; this.healthText.setText("Health: " + this.health); if (tg) tg.HapticFeedback.notificationOccurred("error"); let s = this.add.sprite(e.x, e.y, "explosion"); s.play("explode_anim").setTint(16711680), this.cameras.main.shake(100, .01), e.destroy(), this.health <= 0 && this.gameOver() }
                gameOver() { if (this.isGameOver) return; this.isGameOver = true; this.physics.pause(); this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + this.sessionScore, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5); if (currentUser && this.sessionScore > 0 && db) { const e = db.collection("users").doc(String(currentUser.id)); e.get().then(t => { if (t.exists) { const s = t.data(); const o = s.score || 0; let i = firebase.firestore.FieldValue.increment(this.sessionScore); this.sessionScore > o && (i = firebase.firestore.FieldValue.increment(this.sessionScore + 100 * this.sessionScore)), e.update({ total_score: firebase.firestore.FieldValue.increment(this.sessionScore), total_pmno_coins: i, score: Math.max(o, this.sessionScore) }) } else e.set({ score: this.sessionScore, total_score: this.sessionScore, total_pmno_coins: this.sessionScore + 100 * this.sessionScore, username: currentUser.username || currentUser.first_name, user_id: currentUser.id }) }).catch(e => console.error("Firebase Error:", e)) } this.time.delayedCall(4e3, () => this.scene.start('LobbyScene')) }
            }

            // --- Oyun Yapılandırması ---
            const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: [Preloader, LobbyScene, GameScene] };
            new Phaser.Game(config);

        } catch (e) {
            document.body.innerHTML = `<h1 style="color:red; padding: 20px;">RUNTIME ERROR: ${e.message}</h1>`;
        }
    }

    // --- Başlatıcı ---
    window.addEventListener('load', startApp);

</script>
</body>
</html>