<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
            <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } canvas { display: block; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">
    const tg = window.Telegram.WebApp;
    const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    let db; // Firebase veritabanı nesnesi

    // --- Firebase Kurulumu (Oyunun Dışında) ---
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc",
            authDomain: "peacemissile-game.firebaseapp.com",
            projectId: "peacemissile-game",
            storageBucket: "peacemissile-game.firebasestorage.app",
            messagingSenderId: "641906716058",
            appId: "1:641906716058:web:1376e93994fab29f049e23"
        };
        // Ensure Firebase is loaded before initializing
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } else {
            console.error("Firebase SDK not loaded. Make sure the Firebase scripts are included before this script.");
        }
    } catch (e) {
        console.error("Firebase initialization failed:", e);
    }

    // ... (rest of your GameScene class and other functions remain the same) ...
    class GameScene extends Phaser.Scene {
        constructor() {
            super({ key: 'GameScene' });
            this.score = 0;
            this.health = 3;
            this.gameIsOver = false;
        }

        preload() {
            // ... preload içeriği aynı ...
            const urlParams = new URLSearchParams(window.location.search);
            this.selectedSide = urlParams.get('side') || 'israel';
            const bgKey = this.selectedSide === 'iran' ? 'iran_bg' : 'israel_bg';
            const bgUrl = `https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/${bgKey}.jpg`;
            this.load.image('background', bgUrl);
            this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
            this.load.image('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif');
        }

        create() {
            const gameWidth = this.cameras.main.width;
            const gameHeight = this.cameras.main.height;

            let bg = this.add.image(gameWidth / 2, gameHeight / 2, 'background');
            bg.setDisplaySize(gameWidth, gameHeight);

            // --- YENİ: HARİTAYA GÖRE BİNA SINIRLARI ---
            this.buildings = this.physics.add.staticGroup();
            
            // Buradaki koordinatları (x, y, genişlik, yükseklik) kendi arka plan resimlerinize göre ayarlayabilirsiniz.
            // setOrigin(0.5, 1) kutuyu dikey olarak alttan hizalar.
            if (this.selectedSide === 'israel') {
                // İsrail (Tel Aviv sahili) için 3 farklı bina bölgesi
                this.buildings.create(gameWidth * 0.25, gameHeight, null)
                    .setSize(gameWidth * 0.4, 180) // soldaki binalar
                    .setOrigin(0.5, 1).setVisible(false).refreshBody();

                this.buildings.create(gameWidth * 0.6, gameHeight, null)
                    .setSize(gameWidth * 0.3, 280) // ortadaki yüksek binalar
                    .setOrigin(0.5, 1).setVisible(false).refreshBody();

                this.buildings.create(gameWidth * 0.85, gameHeight, null)
                    .setSize(gameWidth * 0.2, 220) // sağdaki binalar
                    .setOrigin(0.5, 1).setVisible(false).refreshBody();
            } else { // iran
                // İran (İsfahan Meydanı) için 2 geniş bina bölgesi
                this.buildings.create(gameWidth * 0.3, gameHeight, null)
                    .setSize(gameWidth * 0.5, 200) // soldaki büyük yapı
                    .setOrigin(0.5, 1).setVisible(false).refreshBody();
                    
                this.buildings.create(gameWidth * 0.8, gameHeight, null)
                    .setSize(gameWidth * 0.3, 170) // sağdaki yapı
                    .setOrigin(0.5, 1).setVisible(false).refreshBody();
            }

            this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
            this.healthText = this.add.text(gameWidth - 16, 16, 'Health: ' + this.health, { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0);

            this.rockets = this.physics.add.group();
            this.physics.add.collider(this.rockets, this.buildings, this.hitBuilding, null, this);
            
            this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true });
        }
        
        // Geri kalan tüm fonksiyonlar (spawnRocket, destroyRocket, hitBuilding, gameOver) BİREBİR AYNI KALIYOR
        spawnRocket(){if(this.gameIsOver)return;const t=Phaser.Math.Between(40,this.cameras.main.width-40),e=this.rockets.create(t,-100,"rocket");e.setAngle(180),e.setVelocityY(Phaser.Math.Between(300,500)),e.setInteractive({useHandCursor:!0}),e.on("pointerdown",()=>this.destroyRocket(e))}
        destroyRocket(t){if(!t.active)return;this.score+=10,this.scoreText.setText("Score: "+this.score);const e=this.add.image(t.x,t.y,"explosion").setScale(.5);this.time.delayedCall(150,()=>e.destroy()),t.destroy()}
        hitBuilding(t,e){if(!t.active)return;this.health-=1,this.healthText.setText("Health: "+this.health),window.Telegram&&window.Telegram.WebApp.HapticFeedback.notificationOccurred("error");const o=this.add.image(t.x,t.y+20,"explosion").setScale(.8).setTint(16711680);this.time.delayedCall(200,()=>o.destroy()),this.cameras.main.shake(100,.01),t.destroy(),this.health<=0&&this.gameOver()}
        gameOver(){this.gameIsOver=!0,this.physics.pause();const t=this.cameras.main.width,e=this.cameras.main.height;this.add.rectangle(t/2,e/2,t,e,0,.7),this.add.text(t/2,e/2,"GAME OVER\nFinal Score: "+this.score,{fontSize:"48px",fill:"#ff0000",align:"center"}).setOrigin(.5),
                // Call saveScore when game is over
                saveScore(this.score);
                window.Telegram&&window.Telegram.WebApp&&this.time.delayedCall(4e3,()=>window.Telegram.WebApp.close())}
    }

       // --- Skoru Kaydeden Bağımsız Fonksiyon ---
    function saveScore(score) {
        if (!db) {
            console.error("Firebase Firestore is not initialized. Score cannot be saved.");
            return;
        }
        if (!currentUser || !currentUser.id) {
            console.warn("Telegram user data not available. Score will not be saved to a specific user.");
            // Optionally, you might want to save to a "guest" or anonymous user
            // or just skip saving if no user is present.
            return;
        }

        const userDocRef = db.collection('users').doc(String(currentUser.id));
        userDocRef.update({
            score: firebase.firestore.FieldValue.increment(score),
            username: currentUser.username || currentUser.first_name
        }).catch(err => {
            if (err.code === 'not-found') {
                userDocRef.set({ score: score, username: currentUser.username || currentUser.first_name });
            } else { console.error("Firebase Error:", err); }
        });
    }
    // --- Oyun Başlangıcı ---
    const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade', arcade: { gravity: { y: 0 } } }, scene: GameScene };
    try { const game = new Phaser.Game(config); } catch (e) { document.body.innerHTML = `<h1 style="color:red;">ERROR: ${e.message}</h1>`; }
</script>
</body>
</html>