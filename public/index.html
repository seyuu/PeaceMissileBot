<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">
function runGame(tg) {
    try {
        const firebaseConfig = { apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc", authDomain: "peacemissile-game.firebaseapp.com", projectId: "peacemissile-game", storageBucket: "peacemissile-game.firebasestorage.app", messagingSenderId: "641906716058", appId: "1:641906716058:web:1376e93994fab29f049e23" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;

        class Preloader extends Phaser.Scene {
            constructor() { super({ key: 'Preloader' }); }
            preload() {
                this.load.image('lobby_bg', 'assets/lobby_bg.jpg');
                this.load.image('play_button', 'assets/play_button.png');
                this.load.image('israel_bg', 'assets/israel_bg.jpg');
                this.load.image('iran_bg', 'assets/iran_bg.jpg');
                this.load.image('rocket', 'assets/rocket.png');
                this.load.image('score_icon', 'assets/score_icon.png');
                this.load.image('coin_icon', 'assets/coin_icon.png');
                this.load.spritesheet('explosion', 'assets/explosion.gif', { frameWidth: 64, frameHeight: 64 });
            }
            create() { this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true }); this.scene.start('LobbyScene'); }
        }

        class LobbyScene extends Phaser.Scene {
            constructor() { super({ key: 'LobbyScene' }); }
            async create() {
                const gameWidth = this.cameras.main.width; const gameHeight = this.cameras.main.height;
                this.add.image(gameWidth / 2, gameHeight / 2, 'lobby_bg').setDisplaySize(gameWidth, gameHeight);
                this.add.text(gameWidth / 2, 100, `Welcome, ${currentUser ? currentUser.first_name : 'Ambassador'}!`, { fontSize: '48px', fill: '#fff', stroke: '#000', strokeThickness: 6 }).setOrigin(0.5);
                
                const playButton = this.add.image(gameWidth / 2, gameHeight - 150, 'play_button').setScale(0.8).setInteractive({ useHandCursor: true });
                playButton.on('pointerdown', () => { this.scene.start('GameScene'); });

                if (currentUser) {
                    const userDocRef = db.collection('users').doc(String(currentUser.id));
                    try {
                        const doc = await userDocRef.get();
                        if (doc.exists) {
                            const data = doc.data();
                            this.displayStats(data.score || 0, data.total_pmno_coins || 0);
                        } else { this.displayStats(0, 0); }
                    } catch (e) { console.error("Error fetching stats:", e); this.displayStats(0, 0); }
                } else { this.displayStats('N/A', 'N/A'); }
            }
            displayStats(highScore, coins) {
                const gameWidth = this.cameras.main.width;
                this.add.image(gameWidth / 2 - 100, 250, 'score_icon').setScale(0.7);
                this.add.text(gameWidth / 2 + 20, 250, `${highScore}\n(High Score)`, { fontSize: '28px', fill: '#fff', align: 'center' }).setOrigin(0.5);
                this.add.image(gameWidth / 2 - 100, 350, 'coin_icon').setScale(0.7);
                this.add.text(gameWidth / 2 + 20, 350, `${coins}\n($PMNOFO)`, { fontSize: '28px', fill: '#fff', align: 'center' }).setOrigin(0.5);
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { super({ key: 'GameScene' }); }
            create() {
                this.sessionScore = 0; this.health = 3; this.isGameOver = false;
                const gameWidth = this.cameras.main.width; const gameHeight = this.cameras.main.height;
                const urlParams = new URLSearchParams(window.location.search);
                const selectedSide = urlParams.get('side') || 'israel';
                this.add.image(gameWidth/2, gameHeight/2, selectedSide==='iran'?'iran_bg':'israel_bg').setDisplaySize(gameWidth, gameHeight);
                this.buildings = this.physics.add.staticGroup();
                this.buildings.create(gameWidth/2, gameHeight, null).setSize(gameWidth, gameHeight*0.2).setOrigin(0.5, 0.8).setVisible(false).refreshBody();
                this.scoreText=this.add.text(16,16,'Score: 0',{fontSize:'32px',fill:'#fff',stroke:'#000',strokeThickness:4});
                this.healthText=this.add.text(gameWidth-16,16,'Health: 3',{fontSize:'32px',fill:'#fff',stroke:'#000',strokeThickness:4}).setOrigin(1,0);
                this.rockets=this.physics.add.group();
                this.physics.add.collider(this.rockets,this.buildings,this.hitBuilding,null,this);
                this.time.addEvent({delay:1300,callback:this.spawnRocket,callbackScope:this,loop:!0});
            }
            spawnRocket(){if(this.isGameOver)return;const e=Phaser.Math.Between(40,this.cameras.main.width-40),t=this.rockets.create(e,-100,"rocket");t.setAngle(180),t.setVelocityY(Phaser.Math.Between(300,500)),t.setInteractive({useHandCursor:!0}),t.on("pointerdown",()=>this.destroyRocket(t))}
            destroyRocket(e){if(!e.active)return;this.sessionScore+=10,this.scoreText.setText("Score: "+this.sessionScore);let t=this.add.sprite(e.x,e.y,"explosion");t.play("explode_anim"),e.destroy()}
            hitBuilding(e,t){if(!e.active)return;this.health-=1,this.healthText.setText("Health: "+this.health),tg.HapticFeedback.notificationOccurred("error");let s=this.add.sprite(e.x,e.y,"explosion");s.play("explode_anim").setTint(16711680),this.cameras.main.shake(100,.01),e.destroy(),this.health<=0&&this.gameOver()}
            gameOver() {
                if(this.isGameOver)return;this.isGameOver=!0;this.physics.pause();
                this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,'GAME OVER\nScore: '+this.sessionScore,{fontSize:'48px',fill:'#ff0000',align:'center'}).setOrigin(0.5);
                if(currentUser&&this.sessionScore>0){
                    const userDocRef=db.collection('users').doc(String(currentUser.id));
                    userDocRef.get().then(e=>{e.exists?userDocRef.update({total_score:firebase.firestore.FieldValue.increment(this.sessionScore),total_pmno_coins:firebase.firestore.FieldValue.increment(this.sessionScore+(this.sessionScore>e.data().score?this.sessionScore*100:0)),score:Math.max(e.data().score,this.sessionScore)}):userDocRef.set({score:this.sessionScore,total_score:this.sessionScore,total_pmno_coins:this.sessionScore+this.sessionScore*100,username:currentUser.username||currentUser.first_name,user_id:currentUser.id})}).catch(e=>console.error("Firebase Error:",e))
                }
                this.time.delayedCall(4e3,()=>this.scene.start('LobbyScene'))
            }
        }
        
        const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: [Preloader, LobbyScene, GameScene] };
        new Phaser.Game(config);
    } catch(e) {
        document.body.innerHTML = `<h1 style="color:red;">Error: ${e.message}</h1>`;
    }
}

if (window.Telegram && window.Telegram.WebApp) {
    Telegram.WebApp.ready(runGame);
} else {
    window.addEventListener('load', runGame);
}
</script>
</body>
</html>