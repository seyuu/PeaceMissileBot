<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">

function initializeGame() {
    // --- 1. KURULUM ---
    const tg = window.Telegram.WebApp;
    const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    let db;
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyBtOkm8dpjVXLzAXCEB5sL_Awqq4HEeemc",
            authDomain: "peacemissile-game.firebaseapp.com",
            projectId: "peacemissile-game",
            storageBucket: "peacemissile-game.firebasestorage.app",
            messagingSenderId: "641906716058",
            appId: "1:641906716058:web:1376e93994fab29f049e23"
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) {
        console.error("Firebase initialization failed:", e);
    }
    
    // --- 2. SAHNELER ---

    class Preloader extends Phaser.Scene {
        constructor() { super({ key: 'Preloader' }); }
        preload() {
            this.load.image('israel_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/israel_bg.jpg');
            this.load.image('iran_bg', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/iran_bg.jpg');
            this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
            this.load.image('destroyed_building', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/destroyed_building.png');
            this.load.spritesheet('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif', { frameWidth: 64, frameHeight: 64 });
        }
        create() {
            this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true });
            this.scene.start('GameScene');
        }
    }
    
    class GameScene extends Phaser.Scene {
        constructor() { super({ key: 'GameScene' }); }
        
        create() {
            this.score = 0; this.health = 3; this.isGameOver = false;
            const gameWidth = this.cameras.main.width; const gameHeight = this.cameras.main.height;
            const urlParams = new URLSearchParams(window.location.search);
            this.selectedSide = urlParams.get('side') || 'israel';
            
            let bg = this.add.image(gameWidth/2, gameHeight/2, this.selectedSide === 'iran' ? 'iran_bg' : 'israel_bg');
            bg.setDisplaySize(gameWidth, gameHeight);

            this.buildings = this.physics.add.staticGroup();
            // ... (Bina oluşturma mantığın buraya gelecek) ...

            this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
            this.healthText = this.add.text(gameWidth - 16, 16, 'Health: 3', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0);

            this.rockets = this.physics.add.group();
            this.physics.add.collider(this.rockets, this.buildings, this.hitBuilding, null, this);
            this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true });
        }
        
        spawnRocket() { if (this.isGameOver) return; const x = Phaser.Math.Between(40, this.cameras.main.width - 40); const rocket = this.rockets.create(x, -100, "rocket"); rocket.setAngle(180); rocket.setVelocityY(Phaser.Math.Between(300, 500)); rocket.setInteractive({ useHandCursor: true }); rocket.on("pointerdown", () => this.destroyRocket(rocket)); }
        destroyRocket(rocket) { if (!rocket.active) return; this.score += 10; this.scoreText.setText("Score: " + this.score); let explosionSprite = this.add.sprite(rocket.x, rocket.y, 'explosion'); explosionSprite.play('explode_anim'); rocket.destroy(); }
        hitBuilding(rocket, building) { if (!rocket.active) return; this.health -= 1; this.healthText.setText("Health: " + this.health); if (tg) tg.HapticFeedback.notificationOccurred("error"); let explosionSprite = this.add.sprite(rocket.x, rocket.y, 'explosion').play('explode_anim').setTint(0xff0000); this.cameras.main.shake(100, 0.01); rocket.destroy(); if (this.health <= 0) this.gameOver(); }
        
        gameOver() {
            if (this.isGameOver) return; this.isGameOver = true; this.physics.pause();
            this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + this.score, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);
            if (currentUser && this.score > 0) { saveScore(this.score); }
            setTimeout(() => { if (tg) tg.close(); }, 4000);
        }
    }

    // --- 3. VERİTABANI FONKSİYONU ---
    function saveScore(sessionScore) {
        if (!db || !currentUser) return;
        const userDocRef = db.collection('users').doc(String(currentUser.id));
        
        db.runTransaction(transaction => {
            return transaction.get(userDocRef).then(doc => {
                if (!doc.exists) {
                    transaction.set(userDocRef, { 
                        score: sessionScore, // En yüksek skor
                        total_score: sessionScore,
                        total_pmno_coins: sessionScore + (sessionScore * 100), // İlk oyun rekor olduğu için bonuslu
                        username: currentUser.username || currentUser.first_name
                    });
                } else {
                    const data = doc.data();
                    const currentHighest = data.score || 0;
                    const currentTotal = data.total_score || 0;
                    const currentCoins = data.total_pmno_coins || 0;
                    
                    let newCoins = currentCoins + sessionScore;
                    let newHighest = currentHighest;

                    if (sessionScore > currentHighest) {
                        newHighest = sessionScore;
                        newCoins += sessionScore * 100; // Rekor bonusu
                    }

                    transaction.update(userDocRef, {
                        score: newHighest,
                        total_score: currentTotal + sessionScore,
                        total_pmno_coins: newCoins
                    });
                }
            });
        }).then(() => {
            console.log("Transaction successfully committed!");
        }).catch(error => {
            console.log("Transaction failed: ", error);
        });
    }

    // --- 4. OYUNU BAŞLATMA ---
    const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: [Preloader, GameScene] };
    const game = new Phaser.Game(config);
}

// --- 5. BAŞLATICI ---
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready(runGame);
} else {
    window.addEventListener('load', runGame);
}
</script>
</body>
</html>