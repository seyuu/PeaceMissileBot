<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peace Missile Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style> body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; } </style>
</head>
<body>
<div id="phaser-game"></div>
<script type="text/javascript">
    function runGame() {
        const tg = window.Telegram.WebApp;
        const currentUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;

        class GameScene extends Phaser.Scene {
            constructor() { super({ key: 'GameScene' }); }
            preload() {
                const urlParams = new URLSearchParams(window.location.search);
                this.selectedSide = urlParams.get('side') || 'israel';
                this.load.image('background', `https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/${this.selectedSide}_bg.jpg`);
                this.load.image('rocket', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/rocket.png');
                this.load.spritesheet('explosion', 'https://raw.githubusercontent.com/seyuu/PeaceMissileBot/main/public/assets/explosion.gif', { frameWidth: 64, frameHeight: 64 });
            }
            create() {
                this.anims.create({ key: 'explode_anim', frames: this.anims.generateFrameNumbers('explosion'), frameRate: 20, repeat: 0, hideOnComplete: true });
                this.sessionScore = 0; this.health = 3; this.isGameOver = false;
                let bg = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, 'background');
                bg.setDisplaySize(this.cameras.main.width, this.cameras.main.height);
                this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
                this.healthText = this.add.text(this.cameras.main.width - 16, 16, 'Health: 3', { fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 4 }).setOrigin(1, 0);
                this.rockets = this.physics.add.group();
                this.time.addEvent({ delay: 1300, callback: this.spawnRocket, callbackScope: this, loop: true });
            }
            spawnRocket() { if (this.isGameOver) return; const e = Phaser.Math.Between(40, this.cameras.main.width - 40); const t = this.rockets.create(e, -100, "rocket"); t.setAngle(180), t.setVelocityY(Phaser.Math.Between(300, 500)), t.setInteractive({ useHandCursor: !0 }), t.on("pointerdown", () => this.destroyRocket(t)) }
            destroyRocket(e) { if (!e.active) return; this.sessionScore += 10; this.scoreText.setText("Score: " + this.sessionScore); let t = this.add.sprite(e.x, e.y, "explosion"); t.play("explode_anim"), e.destroy() }
            update() { if (this.isGameOver) return; this.rockets.children.each(e => { if (e.y > this.cameras.main.height + 100) { e.destroy(); this.health -= 1; this.healthText.setText("Health: " + this.health); if (this.health <= 0) this.gameOver() } }) }
            
            gameOver() {
                if (this.isGameOver) return;
                this.isGameOver = true; this.physics.pause();
                this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER\nScore: ' + this.sessionScore, { fontSize: '48px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);
                
                // Skoru bota gÃ¶nder
                if (currentUser && this.sessionScore >= 0) {
                    const dataToSend = {
                        user_id: currentUser.id,
                        final_score: this.sessionScore
                    };
                    tg.sendData(JSON.stringify(dataToSend));
                }
                
                setTimeout(() => tg.close(), 2000);
            }
        }
        
        const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: GameScene };
        new Phaser.Game(config);
    }
    
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready(runGame);
    } else {
        window.addEventListener('load', runGame);
    }
</script>
</body>
</html>